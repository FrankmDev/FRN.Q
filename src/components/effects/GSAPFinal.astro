---
/**
 * GSAPFinal - Sistema GSAP simplificado y estable
 * Versión sin opacity:0 inicial - elementos visibles por defecto
 */
---

<script is:inline>
  (function() {
    'use strict';
    
    console.log('[GSAPFinal] Initializing...');
    
    var SCRAMBLE_CHARS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    var activeScrambles = new Map();
    
    // Text scramble - versión estable
    function textScramble(element, finalText) {
      if (!element || element.dataset.scrambling === 'true') return;
      
      var originalText = finalText || element.dataset.originalText || element.textContent || '';
      if (!element.dataset.originalText) {
        element.dataset.originalText = originalText;
      }
      
      // Cancelar animación anterior
      if (activeScrambles.has(element)) {
        clearInterval(activeScrambles.get(element));
        activeScrambles.delete(element);
      }
      
      element.dataset.scrambling = 'true';
      var frame = 0;
      var totalFrames = 15; // Más corto = más estable
      
      var interval = setInterval(function() {
        frame++;
        var progress = frame / totalFrames;
        var result = '';
        
        for (var i = 0; i < originalText.length; i++) {
          if (originalText[i] === ' ') {
            result += ' ';
          } else if (progress > (i / originalText.length) * 0.5 + 0.5) {
            result += originalText[i];
          } else {
            result += SCRAMBLE_CHARS[Math.floor(Math.random() * SCRAMBLE_CHARS.length)];
          }
        }
        
        element.textContent = result;
        
        if (frame >= totalFrames) {
          clearInterval(interval);
          element.textContent = originalText;
          element.dataset.scrambling = 'false';
          activeScrambles.delete(element);
        }
      }, 33); // ~30fps
      
      activeScrambles.set(element, interval);
    }
    
    function initAnimations() {
      if (typeof window.gsap === 'undefined') {
        console.log('[GSAPFinal] GSAP not loaded yet, retrying...');
        setTimeout(initAnimations, 100);
        return;
      }
      
      var gsap = window.gsap;
      
      // Hero animations
      var letters = document.querySelectorAll('.hero-letter');
      if (letters.length > 0) {
        gsap.from(letters, {
          y: 80, opacity: 0, duration: 0.8, stagger: 0.06, ease: 'power4.out', delay: 0.2
        });
      }
      
      // Hero label, scroll, meta
      var heroElements = ['#hero-label', '#hero-scroll', '#hero-meta'];
      heroElements.forEach(function(sel, i) {
        var el = document.querySelector(sel);
        if (el) {
          gsap.from(el, { y: 20, opacity: 0, duration: 0.6, delay: 0.5 + (i * 0.15), ease: 'power3.out' });
        }
      });
      
      // Hero line
      var heroLine = document.querySelector('#hero-line');
      if (heroLine) {
        gsap.from(heroLine, { scaleX: 0, duration: 0.8, delay: 0.8, ease: 'power3.out' });
      }
      
      // ScrollTrigger animations
      if (typeof window.ScrollTrigger !== 'undefined') {
        gsap.registerPlugin(window.ScrollTrigger);
        
        // About stats
        var aboutStats = document.querySelectorAll('.about-stat');
        if (aboutStats.length > 0) {
          gsap.from(aboutStats, {
            y: 30, opacity: 0, duration: 0.6, stagger: 0.1, ease: 'power3.out',
            scrollTrigger: { trigger: '.about-stat', start: 'top 85%', toggleActions: 'play none none reverse' }
          });
        }
        
        // Project Cards
        var cards = document.querySelectorAll('[data-project-card]');
        if (cards.length > 0) {
          gsap.from(cards, {
            y: 40, opacity: 0, duration: 0.7, stagger: 0.1, ease: 'power3.out',
            scrollTrigger: { trigger: cards[0], start: 'top 85%' }
          });
        }
        
        // Services
        var serviceRows = document.querySelectorAll('.service-row');
        if (serviceRows.length > 0) {
          gsap.from(serviceRows, {
            y: 30, opacity: 0, duration: 0.5, stagger: 0.08, ease: 'power3.out',
            scrollTrigger: { trigger: '.service-row', start: 'top 85%', toggleActions: 'play none none reverse' }
          });
        }
        
        // Tech items hover con scramble
        var techItems = document.querySelectorAll('.tech-item');
        techItems.forEach(function(item) {
          var textEl = item.querySelector('span:last-child');
          var originalText = textEl ? textEl.textContent : '';
          
          item.addEventListener('mouseenter', function() {
            if (window.gsap) gsap.to(item, { x: 10, duration: 0.3, ease: 'power2.out' });
            if (textEl) textScramble(textEl, originalText);
          });
          
          item.addEventListener('mouseleave', function() {
            if (window.gsap) gsap.to(item, { x: 0, duration: 0.3, ease: 'power2.out' });
          });
        });
        
        // Service rows con scramble
        serviceRows.forEach(function(row) {
          var title = row.querySelector('.service-title');
          if (!title) return;
          
          var originalTitle = title.textContent;
          
          row.addEventListener('mouseenter', function() {
            if (window.gsap) gsap.to(title, { x: 15, duration: 0.35, ease: 'power2.out' });
            textScramble(title, originalTitle);
          });
          
          row.addEventListener('mouseleave', function() {
            if (window.gsap) gsap.to(title, { x: 0, duration: 0.3, ease: 'power2.out' });
          });
        });
        
        // Project Card titles con scramble
        var projectCards = document.querySelectorAll('[data-project-card]');
        projectCards.forEach(function(card) {
          var title = card.querySelector('.card-title');
          if (!title) return;
          
          var originalTitle = title.textContent;
          
          card.addEventListener('mouseenter', function() {
            textScramble(title, originalTitle);
          });
        });
      }
      
      console.log('[GSAPFinal] Animations initialized');
    }
    
    // Iniciar cuando el DOM esté listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initAnimations);
    } else {
      initAnimations();
    }
    
  })();
</script>
